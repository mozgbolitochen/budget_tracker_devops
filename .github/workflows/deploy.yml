# .github/workflows/deploy.yml

name: Ansible Deploy to Yandex Cloud VM

# Запуск рабочего процесса при каждом пуше в ветку master (или main)
on:
  push:
    branches:
      - master
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest # Используем стандартный раннер GitHub

    steps:
      # 1. Загрузка кода репозитория
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Настройка SSH-доступа
      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          # Используем наш приватный ключ из секретов GitHub
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 3. Установка Ansible и Python
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y ansible python3-pip
          pip3 install "ansible==5.10.0"

      # 4. Обновление инвентаризации IP-адресом
      - name: Create Dynamic Inventory File
        run: |
          echo "[webservers]" >> inventory.temp
          echo "${{ secrets.VM_HOST_IP }}" >> inventory.temp
          echo "" >> inventory.temp
          echo "[webservers:vars]" >> inventory.temp
          echo "ansible_connection=ssh" >> inventory.temp
          echo "ansible_user=ubuntu" >> inventory.temp
          echo "ansible_python_interpreter=/usr/bin/python2.7" >> inventory.temp

      # 5. Запуск плейбука Ansible
      - name: Run Ansible Playbook (Full Setup)
        run: |
          ansible-playbook -i inventory.temp deploy.yml --limit all --verbose
        env:
          # Убеждаемся, что Ansible использует правильные права доступа (sudo)
          ANSIBLE_BECOME_METHOD: sudo
          ANSIBLE_HOST_KEY_CHECKING: False # Отключаем проверку ключей (для CI/CD)
          ANSIBLE_REMOTE_USER: ubuntu # Указываем пользователя на VM
