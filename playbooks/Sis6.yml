# Sis6.yml

- name: SIS 6 - Working with journals
  hosts: webservers
  become: yes

  vars:
    scripts_dir: /usr/local/bin

  tags: [sis6, monitoring]

  tasks:
    # 1. Setting up journalling everything :D
    - name: 6.1 Setting up journaling everything :D
      tags: [sis6, task1]
      block:
      - name: 6.1.1. Ensure logging and auditing tools are installed
        ansible.builtin.apt:
          name:
            - rsyslog
            - systemd-journal-remote
            - auditd
          state: present
          update_cache: yes

      - name: 6.1.2 Ensure rsyslog is running
        ansible.builtin.systemd:
          name: rsyslog
          enabled: yes
          state: started

      - name: 6.1.3 Enable persistent storage for systemd-journald
        ansible.builtin.lineinfile:
          path: /etc/systemd/journald.conf
          regexp: '^#?Storage='
          line: 'Storage=persistent'
          state: present
        notify: Restart systemd-journald

        # 2. Creating a toolset of journaling :D

    - name: 6.2. Creating a toolset of journaling :D
      tags: [sis6, task2]
      block:
      - name: 6.2.1 Create filter script (journal_filter_service.sh)
        ansible.builtin.copy:
          dest: "{{ scripts_dir }}/journal_filter_service.sh"
          mode: '0755'
          content: |
            #!/bin/bash
            if [ -z "$1" ]; then
              echo "Usage: $0 <service_name>"
              exit 1
            fi
            echo "--- Logs for service: $1 ---"
            journalctl -u "$1" --no-pager -n 100

      - name: 6.2.2 Create search script (journal_search_pattern.sh)
        ansible.builtin.copy:
          dest: "{{ scripts_dir }}/journal_search_pattern.sh"
          mode: '0755' 
          content: |
            #!/bin/bash
            if [ -z "$1" ]; then
              echo "Usage: $0 <keyword>"
              exit 1
            fi
            echo "--- Searching logs for: $1 ---"
            journalctl -g "$1" --no-pager

          # 3. Setting an auditing events :D
    - name: 6.3. Setting an auditing events :D
      tags: [sis6, task3]
      block:
      - name: 6.3.1 Configure audit rules for sudoers
        ansible.builtin.copy:
          dest: /etc/audit/rules.d/sis6_audit.rules
          content: |
            -w /etc/sudoers -p wa -k scope_sudoers_change
            
            -w /etc/sudoers.d/ -p wa -k scope_sudoers_dir_change
          mode: '0640'
        notify: Restart auditd

      - name: 6.3.2 Ensure auditd is enabled
        ansible.builtin.service:
          name: auditd
          state: started
          enabled: yes

  handlers:
    - name: Restart systemd-journald
      ansible.builtin.systemd:
        name: systemd-journald
        state: restarted

    - name: Restart auditd
      ansible.builtin.service:
        name: auditd
        state: restarted
